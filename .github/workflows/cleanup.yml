name: "[Cleanup] Remove -old assets from releases"

on:
  workflow_dispatch:
    inputs:
      dry_run:
        description: "‰ªÖÊ£ÄÊü•Ôºå‰∏çÂÆûÈôÖÂà†Èô§Ôºàtrue/falseÔºâ"
        required: false
        default: "true"
      batch_size:
        description: "ÊØèÊâπÂ§ÑÁêÜÂ§öÂ∞ë‰∏™ÁâàÊú¨ÔºàÈªòËÆ§ 50Ôºâ"
        required: false
        default: "50"

permissions:
  contents: write

jobs:
  cleanup:
    name: Remove -old assets from all releases
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with: { fetch-depth: 0 }

      - name: Install tools
        run: |
          sudo apt-get update
          sudo apt-get install -y jq
          gh --version

      - name: Verify all releases are updated and clean up
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          DRY_RUN: ${{ github.event.inputs.dry_run || 'true' }}
          BATCH_SIZE: ${{ github.event.inputs.batch_size || '50' }}
        run: |
          set -e

          if [ ! -f public/version.json ]; then
            echo "‚ùå public/version.json not found!"
            exit 1
          fi

          # ËØªÂèñÊâÄÊúâÁâàÊú¨
          versions=$(jq -r '.[]' public/version.json)
          total=$(echo "$versions" | wc -l)
          echo "Total versions in version.json: $total"
          echo ""

          # ============================================
          # Á¨¨‰∏ÄÈò∂ÊÆµÔºöÊ£ÄÊü•ÊâÄÊúâ release ÊòØÂê¶ÈÉΩÂ∑≤Êõ¥Êñ∞
          # ============================================
          echo "=========================================="
          echo "Phase 1: Verify all releases have been updated"
          echo "=========================================="

          not_updated=()
          missing_release=()
          no_assets=()
          updated=()
          check_count=0

          for v in $versions; do
            check_count=$((check_count + 1))

            # rate limit: ÊØè 50 ‰∏™ÊöÇÂÅú‰∏Ä‰∏ã
            if [ $((check_count % 50)) -eq 0 ]; then
              echo "  [rate-limit] Pausing 5s after $check_count checks..."
              sleep 5
            fi

            # Ê£ÄÊü• release ÊòØÂê¶Â≠òÂú®
            if ! gh release view "$v" >/dev/null 2>&1; then
              echo "  [$check_count/$total] $v ‚Äî ‚ö†Ô∏è  release does not exist"
              missing_release+=("$v")
              continue
            fi

            # Ëé∑ÂèñÊâÄÊúâ asset ÂêçÁß∞
            assets=$(gh release view "$v" --json assets --jq '.assets[].name' 2>/dev/null || true)

            if [ -z "$assets" ]; then
              echo "  [$check_count/$total] $v ‚Äî ‚ö†Ô∏è  release exists but has no assets"
              no_assets+=("$v")
              continue
            fi

            # Ê£ÄÊü•ÊòØÂê¶Êúâ -old ËµÑ‰∫ßÔºàËØ¥ÊòéÂ∑≤Ë¢´Êõ¥Êñ∞ËøáÔºâ
            has_old=false
            if echo "$assets" | grep -q "\-old\."; then
              has_old=true
            fi

            # Ê£ÄÊü•ÊòØÂê¶ÊúâÊñ∞ÁöÑÔºàÈùû -oldÔºâËµÑ‰∫ß
            has_new=false
            for a in $assets; do
              if ! echo "$a" | grep -q "\-old\."; then
                has_new=true
                break
              fi
            done

            if [ "$has_old" = true ] && [ "$has_new" = true ]; then
              echo "  [$check_count/$total] $v ‚Äî ‚úÖ updated (has both old and new assets)"
              updated+=("$v")
            elif [ "$has_old" = true ] && [ "$has_new" = false ]; then
              echo "  [$check_count/$total] $v ‚Äî ‚ùå BROKEN: only has -old assets, no new assets!"
              not_updated+=("$v")
            else
              echo "  [$check_count/$total] $v ‚Äî ‚ùå not updated (no -old assets found)"
              not_updated+=("$v")
            fi
          done

          echo ""
          echo "=========================================="
          echo "Phase 1 Summary"
          echo "=========================================="
          echo "  ‚úÖ Updated (has -old + new assets): ${#updated[@]}"
          echo "  ‚ùå Not updated:                     ${#not_updated[@]}"
          echo "  ‚ö†Ô∏è  Missing release:                ${#missing_release[@]}"
          echo "  ‚ö†Ô∏è  No assets:                      ${#no_assets[@]}"
          echo ""

          if [ ${#not_updated[@]} -gt 0 ]; then
            echo "‚ùå The following versions have NOT been updated yet:"
            printf '  - %s\n' "${not_updated[@]}"
            echo ""
          fi

          if [ ${#missing_release[@]} -gt 0 ]; then
            echo "‚ö†Ô∏è  The following versions have no release:"
            printf '  - %s\n' "${missing_release[@]}"
            echo ""
          fi

          if [ ${#no_assets[@]} -gt 0 ]; then
            echo "‚ö†Ô∏è  The following versions have empty releases:"
            printf '  - %s\n' "${no_assets[@]}"
            echo ""
          fi

          # Â¶ÇÊûúÊúâÊú™Êõ¥Êñ∞ÁöÑÁâàÊú¨Ôºå‰∏≠Ê≠¢Ê∏ÖÁêÜ
          if [ ${#not_updated[@]} -gt 0 ]; then
            echo "============================================================"
            echo "‚ùå ABORT: ${#not_updated[@]} versions are not yet updated."
            echo "   Please run the update workflow first to update all versions."
            echo "   No -old assets will be deleted."
            echo "============================================================"
            exit 1
          fi

          echo "‚úÖ All ${#updated[@]} releases have been updated with v2 patches."
          echo ""

          # ============================================
          # Á¨¨‰∫åÈò∂ÊÆµÔºöÂà†Èô§ -old ËµÑ‰∫ß
          # ============================================
          if [ "$DRY_RUN" = "true" ]; then
            echo "=========================================="
            echo "Phase 2: DRY RUN ‚Äî listing -old assets that would be deleted"
            echo "=========================================="
          else
            echo "=========================================="
            echo "Phase 2: Deleting -old assets from all releases"
            echo "=========================================="
          fi

          deleted_total=0
          processed=0

          for v in "${updated[@]}"; do
            processed=$((processed + 1))

            # rate limit
            if [ $((processed % 30)) -eq 0 ]; then
              echo "  [rate-limit] Pausing 3s after $processed versions..."
              sleep 3
            fi

            assets=$(gh release view "$v" --json assets --jq '.assets[].name' 2>/dev/null || true)
            old_assets=()

            for a in $assets; do
              if echo "$a" | grep -q "\-old\."; then
                old_assets+=("$a")
              fi
            done

            if [ ${#old_assets[@]} -eq 0 ]; then
              continue
            fi

            for old_asset in "${old_assets[@]}"; do
              if [ "$DRY_RUN" = "true" ]; then
                echo "  [DRY RUN] Would delete: $v / $old_asset"
              else
                echo "  Deleting: $v / $old_asset"
                if gh release delete-asset "$v" "$old_asset" --yes 2>/dev/null; then
                  deleted_total=$((deleted_total + 1))
                else
                  echo "    ‚ö†Ô∏è  Failed to delete $old_asset from $v"
                fi
              fi
            done
          done

          echo ""
          echo "=========================================="
          echo "Phase 2 Summary"
          echo "=========================================="
          if [ "$DRY_RUN" = "true" ]; then
            echo "  üîç DRY RUN mode ‚Äî no assets were actually deleted."
            echo "  To actually delete, re-run with dry_run=false"
          else
            echo "  üóëÔ∏è  Total -old assets deleted: $deleted_total"
          fi
          echo "  Done."
