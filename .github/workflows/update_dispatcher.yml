name: "[Dispatcher] Update releases with v2 patches"

on:
  workflow_dispatch:
    inputs:
      parallel_workers:
        description: "同时启动多少个 worker workflow（默认 3）"
        required: false
        default: "3"
      versions_per_worker:
        description: "每个 worker 处理多少个版本（默认 6）"
        required: false
        default: "6"

permissions:
  contents: read
  actions: write

jobs:
  dispatch:
    name: Dispatch parallel workers
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with: { fetch-depth: 0 }

      - name: Check remaining versions
        id: check
        run: |
          if [ ! -f public/update_needed.json ]; then
            echo "remaining=0" >> $GITHUB_OUTPUT
            exit 0
          fi
          remaining=$(python3 -c "import json; d=json.load(open('public/update_needed.json')); print(len(d))")
          echo "remaining=$remaining" >> $GITHUB_OUTPUT
          echo "Remaining versions to update: $remaining"

      - name: Dispatch workers
        if: steps.check.outputs.remaining != '0'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PARALLEL: ${{ github.event.inputs.parallel_workers || '3' }}
          PER_WORKER: ${{ github.event.inputs.versions_per_worker || '6' }}
          REMAINING: ${{ steps.check.outputs.remaining }}
        run: |
          set -e
          REF="${GITHUB_REF_NAME:-main}"

          # 计算实际需要多少个 worker
          # 每个 worker 处理 PER_WORKER 个版本，用 ceil(remaining / per_worker) 计算需要的总块数
          needed_workers=$(( (REMAINING + PER_WORKER - 1) / PER_WORKER ))
          if [ "$needed_workers" -gt "$PARALLEL" ]; then
            actual_workers=$PARALLEL
          else
            actual_workers=$needed_workers
          fi

          echo "=============================="
          echo "Total remaining: $REMAINING"
          echo "Versions per worker: $PER_WORKER"
          echo "Max parallel workers: $PARALLEL"
          echo "Needed workers (ceil): $needed_workers"
          echo "Actual workers to dispatch: $actual_workers"
          echo "Total versions this round: $(( actual_workers * PER_WORKER < REMAINING ? actual_workers * PER_WORKER : REMAINING ))"
          echo "=============================="

          for i in $(seq 0 $((actual_workers - 1))); do
            start=$(( i * PER_WORKER ))
            end=$(( start + PER_WORKER ))
            if [ "$end" -gt "$REMAINING" ]; then
              end=$REMAINING
            fi
            count=$(( end - start ))
            echo "Dispatching worker shard $i: versions [$start, $end) = $count versions"
            curl -s -X POST \
              -H "Authorization: Bearer $GITHUB_TOKEN" \
              -H "Accept: application/vnd.github+json" \
              "https://api.github.com/repos/${GITHUB_REPOSITORY}/actions/workflows/update_worker.yml/dispatches" \
              -d "{\"ref\":\"${REF}\",\"inputs\":{\"shard_index\":\"${i}\",\"shard_total\":\"${actual_workers}\",\"max_per_run\":\"${PER_WORKER}\"}}"
            echo "  -> Worker $i dispatched."
            sleep 1
          done

          echo ""
          echo "All $actual_workers workers dispatched."
          if [ "$needed_workers" -gt "$actual_workers" ]; then
            leftover=$(( REMAINING - actual_workers * PER_WORKER ))
            echo "⚠️  $leftover versions remain unhandled. Re-run dispatcher after this round completes."
          fi

      - name: No versions remaining
        if: steps.check.outputs.remaining == '0'
        run: echo "No versions remaining in update_needed.json. Nothing to do."
